version: '2'
services:
    consul:
        image: consul
        ports:
            - "8500:8500"
    registrator: 
        image: gliderlabs/registrator:latest
        volumes:
            - /var/run/docker.sock:/tmp/docker.sock
        command: consul://localhost:8500
        network_mode: host

    doc-identity:
        image: schwamster/doc-identity
        ports: 
            - "3004:80"
        environment: 
            - Identity:DocStackAppHost=http://localhost:4200
            - Identity:DocStackAppApiHost=http://localhost:3002
            - Identity:AdminPassword=${DocStackAdminPassword}
        depends_on: 
            - consul
            - registrator
        labels: 
            - "SERVICE_TAGS=v1"

    doc-stack-app:
        image: schwamster/doc-stack-app
        ports: 
            - "4200:80"
        depends_on: 
            - consul
            - registrator
        links:
            - doc-stack-app-api
            - doc-identity
            - consul
        environment: 
            - IdentityAuthority=http://doc-identity

    doc-store:
        image: schwamster/doc-store
        ports: 
            - "3003:80"
        depends_on: 
            - consul
            - registrator
        links:
            - rethinkdb
        environment: 
            - RethinkDb:Host=rethinkdb
            - IdentityAuthority=http://doc-identity

    doc-stack-app-api:
        image: schwamster/doc-stack-app-api
        environment: 
            - TextExtractQueue=documents:process:0
            - DocStackApp=http://localhost:4200
            - AlternativeIdentityServer=http://localhost:3004
            - IdentityServerUrl=http://localhost
        ports: 
            - "3002:80"
        links:
            - redis
            - doc-store
            - doc-identity:localhost
            - consul
        depends_on: 
            - consul
            - registrator

    redis:
        image: redis:alpine
        ports: ["6379:6379"]
        depends_on: 
            - consul
            - registrator
    
    rethinkdb:
        image: rethinkdb:2.3.5
        command: rethinkdb --bind all
        volumes:
            - ./rethinkdb-data:/data
        ports: ["28015:28015", "29015:29015", "6001:8080"]
        depends_on: 
            - consul
            - registrator
    
    text-worker:
        image: schwamster/text-worker
        environment: 
            - Queue=documents:process:0
            - OcrServiceHost=ocr_service:5000
            - RedisHost=redis
            - DocStoreHost=doc-store
        links:
            - redis
            - ocr_service
        depends_on: 
            - consul
            - registrator

    pdf_to_text:
        image: schwamster/pdf_to_text
        command: nodemon -L --debug=5858
        ports:
            - "3000:3000"
            - "5858:5858"
        links:
            - ocr_service
        depends_on: 
            - consul
            - registrator

    luis_adapter_service:
        image: schwamster/luis_adapter_service
        command: nodemon -L --debug=5858
        ports:
            - "3001:3000"
            - "5859:5858"
        environment: 
            - LuisAppId=5e5610fe-0f83-4058-882a-08977872d91e
            - LuisSubscriptionKey=${LuisSubscriptionKey}
        depends_on: 
            - consul
            - registrator

    ocr_service:
        image: schwamster/ocr_service
        ports: 
            - "5001:5000"
        command: host
        environment:
            - ComputerVisionKey=${ComputerVisionKey}
        depends_on: 
            - consul
            - registrator
